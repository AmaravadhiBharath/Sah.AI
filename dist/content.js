var Pe=Object.defineProperty;var Le=(h,b,y)=>b in h?Pe(h,b,{enumerable:!0,configurable:!0,writable:!0,value:y}):h[b]=y;var f=(h,b,y)=>Le(h,typeof b!="symbol"?b+"":b,y);(function(){"use strict";class h{deepQuerySelectorAll(n,e=document){let t=[];try{t=Array.from(e.querySelectorAll(n))}catch{console.warn("[SahAI] Invalid selector:",n)}const s=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT);let c;for(;c=s.nextNode();){const a=c;a.shadowRoot&&(t=[...t,...this.deepQuerySelectorAll(n,a.shadowRoot)])}return t}cleanText(n){return n.replace(/\s+/g," ").trim()}isUIElement(n){return/^(copy|regenerate|share|edit|delete|save|retry|cancel|submit|send|stop|continue|new chat|clear)$/i.test(n.trim())||n.trim().length<3}getVisibleText(n){const e=n;return e.innerText||e.textContent||""}getScrollContainer(){const n=["main",'[class*="scroll-area"]','[class*="messages-container"]','[class*="chat-scroll"]','div[style*="overflow-y: auto"]','div[style*="overflow-y: scroll"]'];for(const c of n){const a=document.querySelector(c);if(a&&a.scrollHeight>a.clientHeight)return a}const e=Array.from(document.querySelectorAll("div"));let t=null,s=0;for(const c of e){const a=c.scrollHeight;a>s&&window.getComputedStyle(c).overflowY!=="hidden"&&(s=a,t=c)}return t||document.documentElement}}class b extends h{constructor(){super(...arguments);f(this,"name","ChatGPT")}detect(){return location.hostname.includes("chatgpt.com")||location.hostname.includes("chat.openai.com")}scrapePrompts(){const e=[],t=new Set,s=this.deepQuerySelectorAll(['[data-message-author-role="user"]','[data-testid^="conversation-turn-"]',"article"].join(", "));return console.log(`[SahAI] ChatGPT candidates found: ${s.length}`),s.filter(a=>!s.some(l=>l!==a&&l.contains(a))).forEach((a,l)=>{if(a.tagName==="ARTICLE"&&(a.querySelector(".markdown")||a.querySelector(".agent-turn")))return;let r=this.cleanText(this.getVisibleText(a));r=r.replace(/^(you said|you)\s*:?\s*/i,"").trim(),r&&!this.isUIElement(r)&&!t.has(r)&&(t.add(r),e.push({content:r,index:l}))}),e}}class y extends h{constructor(){super(...arguments);f(this,"name","Claude")}detect(){return location.hostname.includes("claude.ai")}scrapePrompts(){const e=[],t=new Set,s=this.deepQuerySelectorAll(['[data-testid="human-message"]',".human-message",'[class*="human"]','[class*="message"]:not([class*="assistant"]):not([class*="ai"]):not([class*="claude"])'].join(", "));return s.filter(a=>!s.some(l=>l!==a&&l.contains(a))).forEach((a,l)=>{const r=this.cleanText(this.getVisibleText(a));r&&!this.isUIElement(r)&&!t.has(r)&&(t.add(r),e.push({content:r,index:l}))}),e}}class ne extends h{constructor(){super(...arguments);f(this,"name","Gemini")}detect(){return location.hostname.includes("gemini.google.com")}scrapePrompts(){const e=[],t=new Set,s=this.deepQuerySelectorAll(["user-query",'[class*="user-query"]','[class*="query-text"]',".query-content",".user-message","[data-query]",'div[data-message-author-role="user"]'].join(", "));if(console.log(`[SahAI] Gemini candidates found: ${s.length}`),s.filter(a=>!s.some(l=>l!==a&&l.contains(a))).forEach((a,l)=>{const r=this.cleanText(this.getVisibleText(a));r&&!this.isUIElement(r)&&!t.has(r)&&(t.add(r),e.push({content:r,index:l}))}),e.length===0){const a=document.querySelector('main, [role="main"]');if(a){const l=a.querySelectorAll('[class*="turn"], [class*="message"]');let r=0;l.forEach(i=>{const u=i.className.toLowerCase();if(u.includes("model")||u.includes("response")||u.includes("answer"))return;const p=this.cleanText(this.getVisibleText(i));p&&p.length>5&&!t.has(p)&&(t.add(p),e.push({content:p,index:r++}))})}}return e}}class oe extends h{constructor(){super(...arguments);f(this,"name","Perplexity")}detect(){return location.hostname.includes("perplexity.ai")}scrapePrompts(){const e=[],t=new Set;if(document.querySelectorAll('[class*="query"], [class*="question"], [class*="user"]').forEach((c,a)=>{const l=c.className.toLowerCase();if(l.includes("answer")||l.includes("response")||l.includes("source"))return;const r=this.cleanText(this.getVisibleText(c));r&&r.length>5&&!this.isUIElement(r)&&!t.has(r)&&(t.add(r),e.push({content:r,index:a}))}),e.length===0){const c=document.querySelectorAll('[class*="thread"] > div, [class*="Thread"] > div');let a=0;c.forEach((l,r)=>{if(r%2===0){const i=this.cleanText(this.getVisibleText(l));i&&i.length>5&&!t.has(i)&&(t.add(i),e.push({content:i,index:a++}))}})}return e.length===0&&document.querySelectorAll('h1, h2, [class*="title"]').forEach((a,l)=>{const r=this.cleanText(this.getVisibleText(a));r&&r.length>10&&r.length<500&&!t.has(r)&&(t.add(r),e.push({content:r,index:l}))}),e}}class se extends h{constructor(){super(...arguments);f(this,"name","DeepSeek")}detect(){return location.hostname.includes("deepseek.com")}scrapePrompts(){const e=[],t=new Set;if(document.querySelectorAll('[class*="user"], [class*="User"], [data-role="user"]').forEach((l,r)=>{const i=this.cleanText(this.getVisibleText(l));i&&!this.isUIElement(i)&&!t.has(i)&&(t.add(i),e.push({content:i,index:r}))}),e.length>0)return e;const c=document.querySelectorAll('[class*="bubble"], [class*="message"]');let a=0;return c.forEach(l=>{const r=l.className.toLowerCase();if(!(r.includes("assistant")||r.includes("bot")||r.includes("ai"))&&(r.includes("user")||r.includes("human"))){const i=this.cleanText(this.getVisibleText(l));i&&i.length>3&&!t.has(i)&&(t.add(i),e.push({content:i,index:a++}))}}),e.length===0&&document.querySelectorAll("main div").forEach((r,i)=>{if(!r.querySelector(".ds-markdown")&&!r.closest(".ds-markdown")){const u=this.cleanText(this.getVisibleText(r));u&&u.length>10&&u.length<2e3&&!t.has(u)&&!u.includes("```")&&!u.startsWith("#")&&(t.add(u),e.push({content:u,index:i}))}}),e}}class re extends h{constructor(){super(...arguments);f(this,"name","Lovable")}detect(){return location.hostname.includes("lovable.dev")}cleanContent(e){const t=e.cloneNode(!0),s=["button","svg","path",'[role="button"]','[aria-hidden="true"]',".lucide",'[class*="chevron"]','[class*="tooltip"]','[class*="badge"]',"nav","header","footer","aside"];return t.querySelectorAll(s.join(", ")).forEach(c=>c.remove()),this.cleanText(this.getVisibleText(t))}isUserPrompt(e){const t=e.className;if(t.includes("whitespace-normal"))return!0;if(t.includes("prose-h1:mb-2"))return!1;let s=e.parentElement,c=0;for(;s&&c<5;){const a=s.className;if(a.includes("justify-end")||a.includes("ml-auto"))return!0;if(a.includes("assistant")||a.includes("bot"))return!1;s=s.parentElement,c++}return!1}extractFromCurrentDOM(){const e=[],t=new Set;return this.deepQuerySelectorAll('[class*="prose"]').forEach(c=>{var i;const a=c;if(!this.isUserPrompt(a))return;const l=((i=a.textContent)==null?void 0:i.trim())||"";if(l.length<2||l.length>5e3||t.has(l))return;const r=this.cleanContent(a);r&&r.length>2&&!t.has(r)&&(t.add(r),e.push({content:r,index:e.length}))}),e}scrapePrompts(){return console.log("[SahAI] Lovable Extraction Engine starting (v1.2.9 - DOM-filtered)..."),this.extractFromCurrentDOM()}getScrollContainer(){let e=document.querySelector("main");if(e&&e.scrollHeight>e.clientHeight)return e;const t=[".flex.flex-col.overflow-y-auto",'[class*="overflow-y-auto"]','[class*="chat-container"]','[class*="messages-container"]',".flex-1.overflow-y-auto",'[role="region"]'];for(const s of t){const c=document.querySelector(s);if(c&&c.scrollHeight>c.clientHeight*1.2)return c}return null}}class ae extends h{constructor(){super(...arguments);f(this,"name","Bolt")}detect(){return location.hostname.includes("bolt.new")}scrapePrompts(){const e=[],t=new Set;if(document.querySelectorAll('[class*="user"], [class*="prompt"], [class*="input-message"]').forEach((l,r)=>{const i=l.className.toLowerCase();if(i.includes("assistant")||i.includes("response")||i.includes("output"))return;const u=this.cleanText(this.getVisibleText(l));u&&!this.isUIElement(u)&&!t.has(u)&&(t.add(u),e.push({content:u,index:r}))}),e.length>0)return e;const c=document.querySelectorAll('[class*="message"], [class*="Message"]');let a=0;return c.forEach(l=>{const r=l.className.toLowerCase();if(r.includes("user")||r.includes("human")||r.includes("you")){const i=this.cleanText(this.getVisibleText(l));i&&i.length>3&&!t.has(i)&&(t.add(i),e.push({content:i,index:a++}))}}),e.length===0&&document.querySelectorAll('[class*="workspace"] [class*="prompt"], [class*="project"] [class*="request"]').forEach((r,i)=>{const u=this.cleanText(this.getVisibleText(r));u&&u.length>5&&!t.has(u)&&(t.add(u),e.push({content:u,index:i}))}),e}}class ie extends h{constructor(){super(...arguments);f(this,"name","Cursor")}detect(){return location.hostname.includes("cursor.sh")||location.hostname.includes("cursor.com")}scrapePrompts(){const e=[],t=new Set;if(document.querySelectorAll('[class*="user-message"], [class*="UserMessage"], [data-role="user"]').forEach((l,r)=>{const i=this.cleanText(this.getVisibleText(l));i&&!this.isUIElement(i)&&!t.has(i)&&(t.add(i),e.push({content:i,index:r}))}),e.length>0)return e;const c=document.querySelectorAll('[class*="chat"] [class*="message"], [class*="conversation"] [class*="turn"]');let a=0;return c.forEach(l=>{const r=l.className.toLowerCase();if(r.includes("assistant")||r.includes("bot")||r.includes("ai")||r.includes("response"))return;const i=this.cleanText(this.getVisibleText(l));i&&i.length>3&&!t.has(i)&&(t.add(i),e.push({content:i,index:a++}))}),e.length===0&&document.querySelectorAll('[class*="command"], [class*="prompt-history"], [class*="input-history"]').forEach((r,i)=>{const u=this.cleanText(this.getVisibleText(r));u&&u.length>5&&!t.has(u)&&(t.add(u),e.push({content:u,index:i}))}),e}}class le extends h{constructor(){super(...arguments);f(this,"name","Meta AI")}detect(){return location.hostname.includes("meta.ai")}scrapePrompts(){const e=[],t=new Set;if(document.querySelectorAll('[class*="user"], [class*="User"], [data-type="user"]').forEach((l,r)=>{const i=l.className.toLowerCase();if(i.includes("assistant")||i.includes("response")||i.includes("meta"))return;const u=this.cleanText(this.getVisibleText(l));u&&!this.isUIElement(u)&&!t.has(u)&&(t.add(u),e.push({content:u,index:r}))}),e.length>0)return e;const c=document.querySelectorAll('[class*="bubble"], [class*="Bubble"]');let a=0;if(c.forEach(l=>{const r=l.className.toLowerCase();if(r.includes("right")||r.includes("user")||r.includes("outgoing")){const i=this.cleanText(this.getVisibleText(l));i&&i.length>3&&!t.has(i)&&(t.add(i),e.push({content:i,index:a++}))}}),e.length===0){const l=document.querySelector('[class*="thread"], [class*="conversation"], [role="log"]');l&&l.querySelectorAll(":scope > div, :scope > li").forEach((i,u)=>{if(i.querySelector('.markdown, pre, code, [class*="response"]'))return;const p=this.cleanText(this.getVisibleText(i));p&&p.length>5&&p.length<2e3&&!t.has(p)&&(t.add(p),e.push({content:p,index:u}))})}return e}}class ce extends h{constructor(){super(...arguments);f(this,"name","generic")}detect(){return!0}scrapePrompts(){const e=window.location.href;let t=[];if(e.includes("gemini.google.com")){const c=(l,r=document)=>{let i=[];r.querySelectorAll(l).forEach(B=>i.push(B));const u=document.createTreeWalker(r,NodeFilter.SHOW_ELEMENT,null);let p;for(;p=u.nextNode();)p.shadowRoot&&(i=i.concat(c(l,p.shadowRoot)));return i},a=c("user-query");if(a.length>0)return a.map((l,r)=>{var u;const i=(u=l.innerText)==null?void 0:u.trim();return i&&i.length>0?{content:i,index:r}:null}).filter(l=>l!==null)}const s=this.findChatContainer();return s&&(t=this.extractMessages(s)),t.length>1e3&&(console.warn("[SahAI] Truncating extraction at 1000 prompts safety limit"),t=t.slice(0,1e3)),t.map((c,a)=>({content:c.content,index:a}))}findChatContainer(){const e=["infinite-scroller",'[role="log"]','[role="main"]',".chat-history",".conversation","main"];for(const t of e){const s=document.querySelector(t);if(s&&s.innerText.length>200)return s}return document.body}extractMessages(e){var a;const t=[],s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let c;for(;c=s.nextNode();){const l=((a=c.textContent)==null?void 0:a.trim())||"",r=c.parentElement;if(l.length<2||this.isSystemNoise(l)||(r==null?void 0:r.tagName.toLowerCase())==="model-response"||r!=null&&r.classList.contains("model-response-text")||(r==null?void 0:r.getAttribute("data-message-author-role"))==="assistant")continue;const i=l.toLowerCase();if(![/should be written (about|on|for)/i,/the story should/i,/story for class \d+/i,/resulting in a positive resolution/i,/clear moral about/i,/focus on (friendship|teamwork|cooperation)/i,/\bmet near\b/i,/help solve through/i,/spend time together/i].some(u=>u.test(l))&&![/^(one|a) (bright|sunny|dark|cold|warm|beautiful|clear) (day|morning|evening|night)/i,/once upon a time/i,/the end/i,/chapter \d+/i,/lived (his|her|their) life/i,/was a (golden retriever|cow|dog|cat|yellow frog|rabbit)/i,/near a (clear|beautiful|sparkling|calm) (pond|river|lake|stream)/i,/who met near/i,/faces a small problem/i].some(u=>u.test(l))&&!(i.startsWith("here is")||i.startsWith("sure, i can")||i.startsWith("i have")||i.startsWith("certainly")||i.startsWith("of course")||i.startsWith("here's a"))){if(l.length>200){const u=["create","write","make","fix","generate","build","explain","how","what","why","list","show","tell","give","help","find","debug"],p=l.split(" ")[0].toLowerCase();if(!u.includes(p))continue}i.includes("the cow, dog, and")||i.includes("yellow frog")||i.includes("calm problem-solving")||i.includes("summarai turns")||i.includes("scattered ai conversations")||i.includes("actionable workflow")||i.includes("work with ai with an edge")||i.includes("generates summaries of all prompts")||i.includes("no duplicates")||i.includes("cancel out the conflict")||/^(\d+\.|-|\*|â€¢)?\s*(the image shows|image of|this image depicts)/i.test(l)||t.push({role:"user",content:l})}}return this.mergeFragments(t)}isSystemNoise(e){return["Regenerate","Modify","Share","Google","Copy","Bad response","Good response"].includes(e)}mergeFragments(e){if(e.length===0)return[];const t=[];let s={...e[0]};for(let c=1;c<e.length;c++){const a=e[c];a.role===s.role?s.content+=`
`+a.content:(t.push(s),s={...a})}return t.push(s),t}}const ue=[new b,new y,new ne,new oe,new se,new re,new ae,new ie,new le,new ce];function I(){return ue.find(o=>o.detect())||null}function N(){const o=I();return o?o.name:null}const _={version:1,platforms:{chatgpt:{userSelectors:['[data-message-author-role="user"]',".user-message"],buttonSelectors:['button[data-testid="send-button"]'],inputSelectors:["#prompt-textarea"]},claude:{userSelectors:[".font-user-message",'[data-test-id="user-message"]'],buttonSelectors:['button[aria-label="Send Message"]'],inputSelectors:['div[contenteditable="true"]']}}},C="remote_selector_config",de="remote_config_last_fetch",x=class x{constructor(){f(this,"config",_)}static getInstance(){return x.instance||(x.instance=new x),x.instance}async initialize(){const n=await chrome.storage.local.get([C,de]);n[C]&&(this.config={..._,...n[C]})}getSelectors(n){return this.config.platforms[n]||null}};f(x,"instance");let k=x;const $={lovable:{name:"Lovable",topAttempts:70,bottomAttempts:70,waitPerScroll:600,stabilityChecks:6,parallelWait:1200},chatgpt:{name:"ChatGPT",topAttempts:40,bottomAttempts:40,waitPerScroll:400,stabilityChecks:4,parallelWait:800},claude:{name:"Claude",topAttempts:40,bottomAttempts:40,waitPerScroll:400,stabilityChecks:4,parallelWait:800},gemini:{name:"Gemini",topAttempts:35,bottomAttempts:35,waitPerScroll:350,stabilityChecks:4,parallelWait:750},perplexity:{name:"Perplexity",topAttempts:35,bottomAttempts:35,waitPerScroll:350,stabilityChecks:4,parallelWait:750},deepseek:{name:"DeepSeek",topAttempts:30,bottomAttempts:30,waitPerScroll:300,stabilityChecks:3,parallelWait:600},bolt:{name:"Bolt.new",topAttempts:30,bottomAttempts:30,waitPerScroll:300,stabilityChecks:3,parallelWait:600},cursor:{name:"Cursor",topAttempts:30,bottomAttempts:30,waitPerScroll:300,stabilityChecks:3,parallelWait:600},"meta-ai":{name:"Meta AI",topAttempts:25,bottomAttempts:25,waitPerScroll:250,stabilityChecks:3,parallelWait:500}};function P(o){const n=o||"generic",e=n.toLowerCase().replace(/\s+/g,"-");return $[e]||(o?$[o]:null)||{name:n,topAttempts:20,bottomAttempts:20,waitPerScroll:250,stabilityChecks:3,parallelWait:500}}function pe(o){const n=P(o);return n.topAttempts>=40?"TIER 1 (Aggressive)":n.topAttempts>=30?"TIER 2 (Moderate)":"TIER 3 (Conservative)"}let L=!1,m=I(),d=N();function me(){m=I(),d=N(),console.log(`[SahAI] Adapter updated: ${d||"unknown"}`),window.__pe_debug={adapter:m,platformName:d,sessionPrompts:g,getConversationId:S,findInputContainer:E},U()}function U(){chrome.runtime.sendMessage({action:"STATUS_RESULT",supported:!!m,platform:d,hasPrompts:m?m.scrapePrompts().length>0:!1})}k.getInstance().initialize(),console.log("[SahAI] Content script loaded v1.2.9"),console.log(`[SahAI] URL: ${window.location.href}`),console.log(`[SahAI] Platform detected: ${d||"unknown"}`);let g=[];window.__pe_debug={adapter:m,platformName:d,sessionPrompts:g,getConversationId:S,findInputContainer:E},m||console.warn("[SahAI] No adapter found for this page. Buttons will not be shown.");let M=null;const he={chatgpt:['button[data-testid="send-button"]','button[data-testid="composer-send-button"]','form button[type="submit"]','button[aria-label*="Send"]'],claude:['button[aria-label="Send Message"]','button[type="submit"]',"fieldset button:last-child"],gemini:['button[aria-label*="Send"]',".send-button",'button[data-test-id="send-button"]'],perplexity:['button[aria-label="Submit"]','button[type="submit"]'],deepseek:['button[data-testid="send-button"]',".send-btn"],lovable:['button[type="submit"]','button[aria-label*="Send"]'],bolt:['button[type="submit"]',".send-button"],cursor:['button[type="submit"]'],"meta-ai":['button[aria-label*="Send"]','button[type="submit"]']},H={chatgpt:["#prompt-textarea",'textarea[data-id="root"]','div[contenteditable="true"][data-placeholder]'],claude:['div[contenteditable="true"]',"fieldset div[contenteditable]"],gemini:[".ql-editor","rich-textarea div[contenteditable]","textarea"],perplexity:["textarea",'div[contenteditable="true"]'],deepseek:["textarea","#chat-input textarea"],lovable:["textarea"],bolt:["textarea"],cursor:["textarea"],"meta-ai":['div[contenteditable="true"]',"textarea"]};function ge(){const o=H[d||""]||["textarea",'[contenteditable="true"]'];for(const t of o){const s=document.querySelector(t);if(s&&s.offsetParent!==null)return s}const n=document.querySelector("textarea");if(n&&n.offsetParent!==null)return n;const e=document.querySelector('[contenteditable="true"]');return e&&e.offsetParent!==null?e:null}function D(o){var n,e;return o?o instanceof HTMLTextAreaElement?o.value.trim():o.getAttribute("contenteditable")==="true"&&(((n=o.innerText)==null?void 0:n.trim())||((e=o.textContent)==null?void 0:e.trim()))||"":""}function F(){const o=H[d||""]||[];for(const t of o){const s=document.querySelector(t);if(s&&s.offsetParent!==null)return s}const n=document.querySelector('textarea:not([type="hidden"])');if(n&&n.offsetParent!==null)return n;const e=document.querySelector('[contenteditable="true"]');return e&&e.offsetParent!==null?e:null}function G(){const o=F(),n=D(o);return n&&n.length>0?(console.log("[SahAI] Captured prompt:",n.slice(0,50)+"..."),n):null}function S(){const o=window.location.href,e={chatgpt:/\/c\/([a-zA-Z0-9-]+)/,claude:/\/chat\/([a-zA-Z0-9-]+)/,gemini:/\/app\/([a-zA-Z0-9-]+)/,perplexity:/\/search\/([a-zA-Z0-9-]+)/,deepseek:/\/chat\/([a-zA-Z0-9-]+)/,lovable:/\/projects\/([a-zA-Z0-9-]+)/,bolt:/\/~\/([a-zA-Z0-9-]+)/,cursor:/\/chat\/([a-zA-Z0-9-]+)/,"meta-ai":/\/c\/([a-zA-Z0-9-]+)/}[d||""];if(e){const s=o.match(e);if(s)return s[1]}const t=new URL(o).pathname;return`fallback_${fe(t)}`}function fe(o){let n=0;for(let e=0;e<o.length;e++){const t=o.charCodeAt(e);n=(n<<5)-n+t,n=n&n}return Math.abs(n).toString(36)}function W(){const o=S();return`sessionPrompts_${d}_${o}`}function V(o){var r;if(!o||o.trim().length===0)return;const n=S(),e=o.trim(),t=e.toLowerCase();if(t.includes("branding approach:")||t.includes("selected option:")||t.includes("choice:")){console.log("[SahAI] Skipping system choice capture");return}if(g.some(i=>w(i.content)===w(e))){console.log("[SahAI] Skipping duplicate prompt");return}const c={content:e,index:g.length,timestamp:Date.now(),conversationId:n,source:"keylog"};g.push(c);const a=W();(r=chrome.storage.session)==null||r.set({[a]:g}).catch(()=>{chrome.storage.local.set({[a]:g})}),console.log(`[SahAI] Session prompts for ${n}: ${g.length}`);const l=(i=2)=>{chrome.runtime.sendMessage({action:"SAVE_SESSION_PROMPTS",prompts:[c],platform:d||"unknown",conversationId:n},u=>{chrome.runtime.lastError?(console.warn("[SahAI] Failed to save prompt:",chrome.runtime.lastError.message),i>0?setTimeout(()=>l(i-1),500):console.error("[SahAI] Could not save prompt after retries. Data saved locally only.")):u!=null&&u.success&&console.log("[SahAI] Prompt saved to background")})};l()}async function z(){var o;try{const n=W(),e=await((o=chrome.storage.session)==null?void 0:o.get(n))||await chrome.storage.local.get(n);e[n]&&(g=e[n],console.log(`[SahAI] Loaded ${g.length} session prompts for conversation`))}catch{console.log("[SahAI] Could not load session prompts")}}function A(){const o=he[d||""]||[];for(const n of o)document.querySelectorAll(n).forEach(t=>{t.getAttribute("data-pe-hooked")||(t.setAttribute("data-pe-hooked","true"),t.addEventListener("mousedown",()=>{const s=G();s&&(t.__peText=s)},!0),t.addEventListener("click",()=>{const s=t.__peText;s&&(V(s),t.__peText=null)},!0),console.log("[SahAI] Hooked send button:",n))})}function v(){const o=F();if(!o||o.getAttribute("data-pe-key-hooked"))return;o.setAttribute("data-pe-key-hooked","true");let n=null;o.addEventListener("keydown",t=>{const s=t.key==="Enter",c=t.key==="Enter"&&(t.ctrlKey||t.metaKey),a=t.key==="Enter"&&t.shiftKey;if(s&&!a||c){const l=G();l&&l.length>0&&(n={text:l,timestamp:Date.now()})}},!0);const e=new MutationObserver(()=>{if(!n)return;if(Date.now()-n.timestamp>2e3){n=null;return}const t=D(o);(!t||t.length<10)&&(V(n.text),n=null)});e.observe(o,{childList:!0,subtree:!0,characterData:!0,attributes:!0,attributeFilter:["value"]}),o.parentElement&&e.observe(o.parentElement,{childList:!0}),console.log("[SahAI] Hooked keyboard submit with MutationObserver")}function be(){if(!m||!d)return;z(),A(),v();let o=null;new MutationObserver(()=>{o&&clearTimeout(o),o=setTimeout(()=>{A(),v()},500)}).observe(document.body,{childList:!0,subtree:!0});let e=location.href;new MutationObserver(()=>{location.href!==e&&(e=location.href,console.log("[SahAI] URL changed, reloading session"),g=[],z(),setTimeout(()=>{A(),v()},1e3))}).observe(document.body,{childList:!0,subtree:!0}),console.log("[SahAI] Real-time capture initialized (optimized)")}async function xe(){if(!m)return;const o=m.getScrollContainer();if(!o){console.warn("[SahAI] No scroll container found, skipping history load");return}const n=P(d),e=pe(d);console.log(`[SahAI] Starting conversation scroll on container: ${o.tagName}`),console.log(`[SahAI] Platform: ${d} (${e})`),console.log(`[SahAI] Config: top=${n.topAttempts}, bottom=${n.bottomAttempts}, wait=${n.waitPerScroll}ms, stability=${n.stabilityChecks}`);let t=0;chrome.runtime.sendMessage({action:"PROGRESS",message:"SahAI is scrolling for extracting your lengthy conversation"}),chrome.runtime.sendMessage({action:"PROGRESS",message:"Discovering all messages..."}),console.log(`[SahAI] Phase 1: Scrolling to bottom (${n.bottomAttempts} attempts)...`);for(let a=0;a<n.bottomAttempts;a++){o.scrollTop=o.scrollHeight,o.scrollTo({top:o.scrollHeight,behavior:"auto"}),await new Promise(r=>setTimeout(r,n.waitPerScroll));const l=o.scrollHeight;if(console.log(`[SahAI] Bottom scroll ${a+1}/${n.bottomAttempts}: height ${l}px (max: ${t}px)`),l===t){console.log("[SahAI] Height stable - all content discovered");break}t=l}console.log(`[SahAI] Phase 2: Scrolling to top (${n.topAttempts} attempts)...`),chrome.runtime.sendMessage({action:"PROGRESS",message:"Navigating to oldest messages..."});let s=0,c=0;for(let a=0;a<n.topAttempts;a++){o.scrollTop=0,o.scrollTo({top:0,behavior:"auto"}),await new Promise(r=>setTimeout(r,n.waitPerScroll));const l=o.scrollHeight;if(console.log(`[SahAI] Top scroll ${a+1}/${n.topAttempts}: height ${l}px (max: ${s}px)`),l===s){if(c++,c>=n.stabilityChecks){console.log(`[SahAI] Top height stable for ${n.stabilityChecks} checks - all oldest messages loaded`);break}}else c=0;s=l}console.log(`[SahAI] Scroll complete. Total height: ${o.scrollHeight}px. Ready for extraction.`)}async function ye(o){const n=[],e=new Set;let t=0;const s=o.getScrollContainer();if(!s)return console.warn("[SahAI] No scroll container for parallel extraction"),o.scrapePrompts();const c=P(d),a=s.scrollHeight;console.log(`[SahAI] Starting parallel extraction from height: ${a}px`),console.log(`[SahAI] Using platform wait time: ${c.parallelWait}ms`);const l=[{name:"TOP",position:0},{name:"25%",position:a*.25},{name:"MIDDLE",position:a*.5},{name:"75%",position:a*.75},{name:"BOTTOM",position:a}];console.log(`[SahAI] Extracting from ${l.length} positions...`);for(const r of l){console.log(`[SahAI] [${r.name}] Scrolling to ${Math.round(r.position)}px...`),s.scrollTop=r.position,s.scrollTo({top:r.position,behavior:"auto"}),await new Promise(u=>setTimeout(u,c.parallelWait));const i=o.scrapePrompts();console.log(`[SahAI] [${r.name}] Found ${i.length} prompts`);for(const u of i)e.has(u.content)?console.log(`[SahAI] [${r.name}] Duplicate: ${u.content.slice(0,40)}...`):(e.add(u.content),u.index=t++,u.source="dom",n.push(u),console.log(`[SahAI] [${r.name}] Added: ${u.content.slice(0,40)}...`))}return console.log(`[SahAI] Parallel extraction complete: ${n.length} unique prompts`),n}async function Z(){m&&await xe();const o=[...g],n=S();let e=[];if(n)try{console.log("[SahAI] Fetching persistent logs for:",n);const a=chrome.runtime.sendMessage({action:"GET_CONVERSATION_LOGS",platform:d,conversationId:n}),l=new Promise(i=>setTimeout(()=>i({prompts:[]}),1500)),r=await Promise.race([a,l]);r&&r.prompts&&(e=r.prompts,console.log(`[SahAI] Found ${e.length} persistent prompts`))}catch(a){console.error("[SahAI] Failed to fetch persistent logs:",a)}let t=[...e];const s=new Set(e.map(a=>w(a.content)));for(const a of o)s.has(w(a.content))||t.push(a);let c=[...t];if(m){console.log("[SahAI] Augmenting with DOM scraping..."),console.log(`[SahAI] Using aggressive parallel extraction for ${d}...`);let a=[];a=await ye(m);const l=new Set(t.map(r=>w(r.content)));for(const r of a)l.has(w(r.content))||c.push(r)}return c.sort((a,l)=>(a.timestamp||0)-(l.timestamp||0))}function w(o){return o.toLowerCase().trim().replace(/\s+/g," ").slice(0,200)}function j(o){const n=S();return{platform:d||"unknown",url:window.location.href,title:document.title,prompts:o,extractedAt:Date.now(),conversationId:n}}const Se=`

  .pe-has-zone1-absolute {
    position: relative !important;
    padding-top: 48px !important;
    overflow: visible !important;
  }

  .pe-zone1 {
    position: absolute !important;
    top: 8px !important;
    left: 8px !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    width: calc(100% - 16px) !important;
    box-sizing: border-box !important;
    background: transparent !important;
    padding-bottom: 0 !important;
    border-bottom: none !important;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif !important;
    z-index: 2147483647 !important;
    pointer-events: auto !important;
    visibility: visible !important;
    opacity: 1 !important;
    height: 32px !important;
  }
  
  .pe-zone1-btn {
    position: relative !important;
    z-index: 10001 !important;
    box-sizing: border-box !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 28px !important;
    min-height: 28px !important;
    max-height: 28px !important;
    padding: 0 12px !important;
    border-radius: 14px !important;
    font-size: 12px !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
    font-weight: 600 !important;
    line-height: 1 !important;
    margin: 0 !important;
    text-transform: none !important;
    letter-spacing: normal !important;
    cursor: pointer !important;
    transition: all 150ms ease !important;
    white-space: nowrap !important;
    pointer-events: auto !important;
    outline: none !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
  }
  
  .pe-zone1-btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
  }

  .pe-zone1-btn:active {
    transform: scale(0.96) !important;
    transition: transform 50ms ease-out !important;
  }

  .pe-zone1-btn.loading {
    pointer-events: none !important;
    opacity: 0.8 !important;
  }
  
  .pe-zone1-btn.extract {
    background: #000000 !important;
    color: #ffffff !important;
    border: 1px solid #000000 !important;
  }
  
  .pe-zone1-btn.summarize {
    background: #ffffff !important;
    color: #000000 !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
  }
  
  .pe-zone1-btn.paste {
    background: #ffffff !important;
    color: #000000 !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
  }
  
  .pe-zone1-btn svg {
    width: 12px !important;
    height: 12px !important;
    margin-right: 6px !important;
    display: inline-block !important;
    vertical-align: middle !important;
    flex-shrink: 0 !important;
    stroke-width: 2.5 !important;
  }

  @keyframes pe-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .pe-spinner {
    animation: pe-spin 1s linear infinite !important;
    transform-origin: center !important;
  }
`,we={chatgpt:["#composer-background",'[data-testid="composer-background"]',"#prompt-textarea-wrapper",'form[class*="stretch"] > div > div','form.w-full > div > div[class*="relative"]',"main form > div > div"],claude:['div:has(> [contenteditable="true"])','div.relative:has([contenteditable="true"])','fieldset:has([contenteditable="true"])','form:has([contenteditable="true"])','[data-testid="composer-container"]',".composer-container"],gemini:["rich-textarea",".input-area",".input-area-container",'section[class*="input-area"]',".text-input-field_textarea-wrapper"],perplexity:['[data-testid="ask-input-container"]',".ask-input-container"],deepseek:[".chat-input-container","#chat-input"],lovable:[".prompt-input-container",'[data-testid="prompt-input"]','div[class*="PromptBox"]','div[class*="InputArea"]'],bolt:[".chat-input",'[data-testid="chat-input"]'],cursor:[".input-container",'[data-testid="input"]'],"meta-ai":['[data-testid="composer"]',".composer"]};function E(){const o=we[d||""]||[];for(const t of o){const s=document.querySelector(t);if(s&&s.offsetParent!==null){if(s.getAttribute("contenteditable")==="true"||s.tagName==="TEXTAREA")continue;const c=window.getComputedStyle(s);if(c.display==="none"||c.visibility==="hidden"||c.opacity==="0")continue;const a=s.getBoundingClientRect();if(a.height>450||a.height<20)continue;return s}}if(d==="claude"){const t=document.querySelector('[contenteditable="true"], textarea');if(t&&t.offsetParent!==null){const s=t.closest("div.relative, fieldset, form");if(s&&s.offsetParent!==null){const l=s.getBoundingClientRect();if(l.height>30&&l.height<450)return s}let c=t.parentElement,a=0;for(;c&&a<6;){const l=c.getBoundingClientRect(),r=c.getAttribute("contenteditable")==="true",i=window.getComputedStyle(c),u=i.display!=="none"&&i.visibility!=="hidden"&&i.opacity!=="0";if(l.height>30&&l.height<400&&!r&&u)return c;c=c.parentElement,a++}}}if(d==="chatgpt"){const t=document.querySelector('form[class*="stretch"], form.w-full');if(t){const s=t.querySelector('div[class*="rounded"]');if(s&&s.offsetParent!==null)return s;const c=t.querySelector(":scope > div > div");if(c)return c}}const n=document.querySelectorAll('textarea, [contenteditable="true"]');for(const t of n)if(t.offsetParent!==null){let s=t.parentElement,c=0;for(;s&&c<6;){const a=window.getComputedStyle(s),l=a.borderRadius&&a.borderRadius!=="0px",r=a.backgroundColor!=="transparent"&&a.backgroundColor!=="rgba(0, 0, 0, 0)";if((l||r)&&s.getBoundingClientRect().height<450)return s;s=s.parentElement,c++}}const e=document.querySelectorAll("form");for(const t of e)if(t.querySelector('textarea, [contenteditable="true"]')&&t.getBoundingClientRect().height<450)return t;return null}function Ae(){if(document.getElementById("pe-styles"))return;const o=document.createElement("style");o.id="pe-styles",o.textContent=Se,(document.head||document.documentElement).appendChild(o)}function K(){const o=document.createElement("div");o.id="pe-zone1",o.className="pe-zone1";const n=document.createElement("button");n.id="pe-extract-btn",n.className="pe-zone1-btn extract",n.textContent="Extract",n.title="Extract raw prompts to SahAI",n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),Y("raw",n)},!0),o.appendChild(n);const e=document.createElement("button");return e.id="pe-summarize-btn",e.className="pe-zone1-btn summarize",e.innerHTML=`
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
      <polyline points="7 10 12 15 17 10" />
      <line x1="12" y1="15" x2="12" y2="3" />
    </svg>
    Summarize
  `,e.title="Extract and summarize prompts with AI",e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),Y("summary",e)},!0),o.appendChild(e),o}function X(o){o.classList.add("loading"),o.innerHTML=`
    <svg class="pe-spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
      <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
    </svg>
    Extracting...
  `}function Q(o,n){o.innerHTML=`
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:14px; height:14px; margin-right:6px; display:inline-block; vertical-align:middle;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    Done!
  `,setTimeout(()=>{o.classList.remove("loading"),o.textContent=n},2e3)}async function Y(o,n){console.log(`[SahAI] Button clicked: ${o}`);const e=o==="summary",t=e?"Summarize":"Extract";chrome.runtime.sendMessage({action:"OPEN_SIDE_PANEL"}),chrome.runtime.sendMessage({action:"EXTRACT_TRIGERED_FROM_PAGE",mode:o}),X(n),e&&(n.innerHTML=`
      <svg class="pe-spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
      </svg>
      Summarizing...
    `);try{console.log("[SahAI] Starting extraction...");const s=await Z();console.log(`[SahAI] Extracted ${s.length} prompts`);const c=j(s);console.log("[SahAI] Sending EXTRACTION_FROM_PAGE to background..."),chrome.runtime.sendMessage({action:"EXTRACTION_FROM_PAGE",result:c,mode:o}),Q(n,t)}catch(s){console.error("[SahAI] Error:",s),n.textContent="Error",setTimeout(()=>{n.classList.remove("loading"),n.textContent=t},2e3)}}function q(){if(console.log("[SahAI] Attempting to create zoned layout..."),document.getElementById("pe-zone1")||!m)return;const o=window.location.href,n=o.includes("/c/")||o.includes("/chat/")||o.includes("/thread/")||o.includes("/projects/"),e=new URL(o),t=(e.hostname.includes("chatgpt.com")||e.hostname.includes("openai.com"))&&(e.pathname==="/"||e.pathname==="");if(d==="claude"){if(window.location.hostname.includes("claude.ai")&&!window.location.pathname.includes("/chat"))return}else if(d==="chatgpt"&&!n&&!t)return;const s=E();if(Ae(),s){s.style.display="",s.style.flexDirection="",s.style.alignItems="",s.style.gap="",s.classList.add("pe-has-zone1-absolute");const c=K();if(s.prepend(c),document.getElementById("pe-zone1")){const a=document.getElementById("pe-floating-zone");a&&a.remove(),d==="claude"&&new MutationObserver(()=>{document.getElementById("pe-zone1")||(console.log("[SahAI] Claude removed buttons, re-injecting..."),s.prepend(K())),s.classList.contains("pe-has-zone1-absolute")||(console.log("[SahAI] Claude removed layout class, re-applying..."),s.classList.add("pe-has-zone1-absolute"),s.style.paddingTop="48px")}).observe(s,{childList:!0,attributes:!0,attributeFilter:["class","style"]})}console.log("[SahAI] Zoned layout initialized (Input Container Mode)")}}function ve(){const o=document.getElementById("pe-zone1");if(!o||document.getElementById("pe-paste-btn"))return;const n=document.createElement("button");n.id="pe-paste-btn",n.className="pe-zone1-btn paste",n.innerHTML=`
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
       <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
       <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
    </svg>
    Paste
  `,n.title="Paste copied prompts into Chat",n.onclick=e=>{e.preventDefault(),e.stopPropagation(),Te()},o.appendChild(n)}function Ee(){const o=document.getElementById("pe-paste-btn");o&&o.remove()}async function Te(){let o=M;if(!o)try{o=await navigator.clipboard.readText()}catch(e){console.error("Failed to read clipboard:",e)}if(!o)return;const n=ge();if(!n){console.error("[SahAI] Could not find input field to paste");return}if(n.focus(),n instanceof HTMLTextAreaElement){const e=n.selectionStart||0,t=n.selectionEnd||0,s=n.value;n.value=s.substring(0,e)+o+s.substring(t),n.selectionStart=n.selectionEnd=e+o.length,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))}else try{document.execCommand("insertText",!1,o)}catch(e){console.error("[SahAI] Standard insertText failed, trying direct innerText update",e),n.innerText=o,n.dispatchEvent(new Event("input",{bubbles:!0}))}console.log("[SahAI] Successfully pasted content"),M=null,Ee()}function R(){const o=document.getElementById("pe-zone1");o&&o.remove();const n=E();n&&(n.style.display="",n.style.flexDirection="",n.style.alignItems="",n.style.gap="");const e=document.getElementById("pe-styles");e&&e.remove()}let J=()=>{};function Ie(){let o=0;const n=10,e=()=>{document.getElementById("pe-zone1")||(q(),!document.getElementById("pe-zone1")&&o<n&&(o++,setTimeout(e,500)))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):setTimeout(e,500);let t=location.href,s=!1,c=!1;const a=()=>{if(s)return;s=!0,(window.requestIdleCallback||(i=>setTimeout(i,100)))(()=>{var ee,te;s=!1,location.href!==t&&(t=location.href,console.log("[SahAI] URL change detected"));const i=window.location.href,u=i.includes("/c/")||i.includes("/chat/")||i.includes("/thread/"),p=new URL(i),B=(p.hostname.includes("chatgpt.com")||p.hostname.includes("openai.com"))&&(p.pathname==="/"||p.pathname==="");let Ce=!!d&&d!=="generic",T=!1;if(d==="claude"?T=window.location.pathname.includes("/chat"):d==="chatgpt"?T=u||B:T=!0,Ce){const ke=!!document.getElementById("pe-zone1");!!document.getElementById("pe-figma-pill-container")&&((ee=document.getElementById("pe-figma-pill-container"))==null||ee.remove()),!ke&&T&&m&&q()}else(document.getElementById("pe-zone1")||document.getElementById("pe-figma-pill-container"))&&(console.log("[SahAI] Removing buttons: No longer on supported platform"),R(),(te=document.getElementById("pe-figma-pill-container"))==null||te.remove());const O=m?m.scrapePrompts().length>0:!1;O!==c&&(c=O,chrome.runtime.sendMessage({action:"STATUS_RESULT",supported:!!m,platform:d,hasPrompts:O}))},{timeout:2e3})};J=a,new MutationObserver(r=>{r.some(u=>u.type==="childList"&&u.addedNodes.length>0)&&a()}).observe(document.documentElement,{childList:!0,subtree:!0}),a()}chrome.runtime.onMessage.addListener((o,n,e)=>{switch(console.log("[SahAI] Received message:",o.action),o.action){case"URL_CHANGED":{console.log("[SahAI] URL changed, resetting session"),me(),g=[],z(),document.getElementById("pe-zone1")&&R(),setTimeout(()=>{J(),A(),v()},500),e({success:!0});break}case"EXTRACT_PROMPTS":{if(L)return console.warn("[SahAI] Extraction already in progress, ignoring request"),e({success:!1,error:"Extraction already in progress. Please wait."}),!0;const t=o.mode;L=!0;const s=document.getElementById("pe-extract-btn"),c=s&&s.textContent||"Extract";return s&&X(s),Z().then(a=>{const l=j(a);chrome.runtime.sendMessage({action:"EXTRACTION_RESULT",result:l,mode:t}),s&&Q(s,c),e({success:!0,promptCount:a.length})}).catch(a=>{console.error("[SahAI] Extraction failed:",a),s&&(s.textContent="Error",setTimeout(()=>{s.classList.remove("loading"),s.textContent=c},2e3)),e({success:!1,error:a.message})}).finally(()=>{L=!1}),!0}case"GET_STATUS":{e({action:"STATUS_RESULT",supported:!!m,platform:d,hasPrompts:m?m.scrapePrompts().length>0:!1});break}case"TOGGLE_BUTTONS":{o.visible?q():R(),e({success:!0});break}case"CONTENT_COPIED":{M=o.content,ve(),e({success:!0});break}default:e({success:!1,error:"Unknown action"})}return!0}),U(),Ie(),be()})();
